---
layout: default

previousLabel: Artists
previousHref: build-it/artists.html
nextLabel: Albums
nextHref: build-it/albums.html
---
<div class="jumbotron">
	<h1>Playlistr: Albums</h1>

	<p class="lead">Let's add another feature.</p>
</div>

<div class="row">
	<div class="col">
		<h2>Albums</h2>
	</div>

	<div class="w-100"></div>

	<div class="col">
		<p>Let's start with another simple <code>CRUD</code> feature. This time to create, read, update and delete an <code>Album</code> in our application. We're going to introduce a couple of new ideas with this one. Firstly we'll use <code>qb</code> inside our <code>commandbox-migrations</code> script rather than raw <code>SQL</code>.</p>

		<h3>Migrate Create</h3>

		<p>If you remember we created our <code>commandbox-migrations</code> script in the command line like so: <code>migrate create albums</code></p>

		<p>With the script templated we can add our <code>qb</code> functions to build our table schema.</p>

		<figure class="figure">
{%- highlight cfscript %}
component {

	function up( schema ) {
		schema.create( "albums", function( table ) {
			table.increments( "id" );

			table.string( "name" );
		} );
	}

	function down( schema ) {
		schema.drop( "albums" );
	}

}
{%- endhighlight %}
			<figcaption class="figure-caption">resources/database/migrations/2018_07_02_100000_albums.cfc</figcaption>
		</figure>

		<p>With <code>qb</code> we have access to closure methods that can create and drop a table as well as add columns definitions. We pass the <code>schema</code> from <code>qb</code> into our <code>up()</code> and <code>down()</code> methods to give us access to the features of <code>qb</code>.</p>

		<p>The <code>create()</code> closure takes the name of the table we want to create, "<em>albums</em>", and a function to define the columns in that table. The <code>increments()</code> method adds an auto-incrementing integer primary key and <code>string()</code> adds a <code>varchar(255)</code> string column to the table.</p>

		<p>In the <code>down()</code> method we'll use <code>drop()</code> to delete our "<em>albums</em>" table.</p>

		<h3>Album Service</h3>

		<p>Now let's introduce the idea of interacting with our database via a service component. </p>










		<h3>Artists.cfc (Controller)</h3>

		<p>Next let's create our handler <code>Artists.cfc</code>. This will be placed in the <code>handlers</code> directory. Like all <code>ColdBox</code> handlers it extends <code>coldbox.system.EventHandler</code>.</p>

		<h4>Action: index()</h4>

		<p>The first and default action function is <code>index()</code>.</p>

		<figure class="figure">
{%- highlight cfscript %}
function index( event, rc, prc ) {
	var artists = getInstance( "Artist" )
		.orderby( "id" )
		.get();

	if( artists.count() == 0 ) {
		relocate( "artists.create" );
	}

	prc.artists = artists.toArray();
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>Hopefully the intent of this method is clear. We first try and get all the <code>Artist</code> entities and if there are none we need to bounce the visitor onto the create view. If there are some artists then we need to convert the collection into an array of <code>Artist</code> entities for the listing view to loop over.</p>

		<p><code>Quick</code> uses it's integration with <code>WireBox</code> to <code>getInstance( "Artist" )</code> of the <code>Artist</code> entity definition. We can then method-chains the <code>orderby( "id" )</code> and <code>get()</code> methods to retrieve the <code>Artist</code> entities, if there are any.</p>

		<h4>Action: create()</h4>

		<p>If there are no <code>Artist</code> entities found, we need to create an <code>Artist</code> with the <code>create()</code> action method.</p>

		<figure class="figure">
{%- highlight cfscript %}
function create( event, rc, prc ) {
	param rc.id = "";

	prc.name = "";

	prc.action = "Create";
	prc.formAction = "artists.createAction";

	event.setView( "artists/createUpdate" );
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>All we are doing here is populating a number of <code>rc</code> and <code>prc</code> variables used in the set <code>artists/createUpdate.cfm</code> view.</p>

		<h4>Action: createAction()</h4>

		<p>When the createUpdate form is submitted the <code>createAction</code> action method is called and the form <code>POST</code> variables are sent to the <code>createAction</code> action method in the <code>rc</code> structure.</p>

		<figure class="figure">
{%- highlight cfscript %}
function createAction( event, rc, prc ) {
	param rc.name = "";

	var artist = getInstance( "Artist" )
		.create( {
			name: rc.name
		} );

	relocate( "artists" );
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>Here the <code>Artist</code> name in the <code>rc</code> structure from the form <code>POST</code> is used to create the record. The primary key <code>id</code> value is provided by the database auto-increment.</p>

		<h4>Action: update()</h4>

		<p>When we come to update an <code>Artist</code> we need to call the <code>update()</code> action method to populate the <code>artists/createUpdate.cfm</code> view.</p>

		<figure class="figure">
{%- highlight cfscript %}
function update( event, rc, prc ) {
	param rc.id = "";

	var artist = getInstance( "Artist" )
		.findOrFail( rc.id )
		.first();

	prc.name = artist.getName();

	prc.action = "Update";
	prc.formAction = "artists.updateAction";

	event.setView( "artists/createUpdate" );
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>Once again we use <code>WireBox</code> to get an instance of our <code>Artist</code> entity. This time we use <code>findOrFail( rc.id )</code> to find our record and <code>first()</code> to return a single <code>Artist</code> entity. The primary key, <code>rc.id</code>, will be passed into the method via the <code>?id=123</code> name / value pair in the URL. If for any reason the primary key value of <code>rc.id</code> is not found, <code>Quick</code> will throw an "<em>EntityNotFound</em>" exception which, in a full application, should be caught with a <code>try/catch</code> around the code.</p>

		<h4>Action: updateAction()</h4>

		<p>When updating an <code>Artist</code> the form action submits to <code>artists.updateAction</code>.</p>

		<figure class="figure">
{%- highlight cfscript %}
function updateAction( event, rc, prc ) {
	param rc.id = "";
	param rc.name = "";

	getInstance( "Artist" )
		.findOrFail( rc.id )
		.update( {
			name: rc.name
		} );

	relocate( "artists" );
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>As you can see, we can find and update our changed <code>Artist</code> all in one expression. The same advice concerning an entity not being found applies.</p>

		<h4>Action: delete()</h4>

		<p>Finally, the last thing we want to do is to delete a record from the database. </p>

		<figure class="figure">
{%- highlight cfscript %}
function delete( event, rc, prc ) {
	param rc.id = "";

	var artist = getInstance( "Artist" )
		.findOrFail( rc.id )
		.delete();

	relocate( "artists" );
}
{%- endhighlight %}
			<figcaption class="figure-caption">models/Artist.cfc</figcaption>
		</figure>

		<p>All the previous notes apply. This time we just call the <code>delete()</code> method on the found <code>Artist</code> entity and then take the visitor back to the listing view.</p>

		<p>Finally we need to build the listing and create / update views we've referenced. There should be no surprises here. The only <code>Quick</code> related feature is in the <code>index.cfm</code> listing view. We are passing an array of <code>Artist</code> entities into the view via the <code>prc.artists</code> variable created in the handler. We then loop over that array to get each <code>Artist</code>. When we have a single <code>Artist</code> we can use the get methods provided by <code>Quick</code> to access the values like <code>artist.getName()</code>.</p>

		<p>So now we have a simple but complete <code>CRUD</code> feature using <code>Quick</code>!</p>

		{% include branch.html branch='0.1.0-artists' %}
	</div>
</div>

{% include footerNav.html
	previousLabel=page.previousLabel
	previousHref=page.previousHref
	nextLabel=page.nextLabel
	nextHref=page.nextHref
%}
